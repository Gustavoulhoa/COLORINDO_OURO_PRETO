<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Colorindo Ouro Preto</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Fredoka+One&display=swap" rel="stylesheet">
  <!-- Remova o style interno e use apenas o link para o CSS externo -->
  <link rel="stylesheet" href="../css/style.css"><style>
    :root {
      --main-bg: #f5f0e6;
      --primary-color: #5d3a1a;
      --hover-color: #7a5c47;
      --active-color: #e91e63;
      --toolbar-bg: rgba(255, 255, 255, 0.95);
    }
  
    body {
      background: var(--main-bg);
      font-family: 'Playfair Display', serif;
      margin: 0;
      padding: 0;
    }
  
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }
  
    .logo-link {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
    }
  
    .logo {
      height: 50px;
      margin-right: 10px;
    }
  
    .header-title {
      font-family: 'Fredoka One', cursive;
      color: var(--primary-color);
      margin: 0;
      font-size: 1.5rem;
    }
  
    #drawing-title {
      font-family: 'Fredoka One', cursive;
      color: var(--primary-color);
      margin: 0;
      font-size: 1.2rem;
      text-align: right;
    }
  
    .canvas-container {
      width: 100%;
      height: calc(100vh - 160px);
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
    }
  
    #drawing-canvas {
      max-width: 100%;
      max-height: 100%;
    }
  
    .toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--toolbar-bg);
      padding: 12px 16px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 100;
    }
  
    .tool {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 6px;
      font-family: 'Fredoka One', cursive;
      font-size: 1rem;
      transition: background 0.2s, transform 0.2s;
    }
  
    .tool:hover {
      background: var(--hover-color);
      transform: translateY(-2px);
    }
  
    .tool.active {
      background: var(--active-color);
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
  
    .tool-control {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0 8px;
      font-family: sans-serif;
      font-size: 0.9rem;
    }
  
    .tool-control input[type="range"] {
      vertical-align: middle;
    }
  
    @media (max-width: 768px) {
      .toolbar {
        padding: 10px;
        gap: 8px;
      }
  
      .tool {
        padding: 6px 10px;
        font-size: 0.9rem;
      }
  
      .tool-control {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
  
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
  
      #drawing-title {
        text-align: left;
        margin-top: 10px;
      }
    }
  </style>
  
</head>
<body>
 
  <header class="header">
    <a href="../index.html" class="logo-link">
      <img src="../assets/logo.png" alt="Logo Colorindo Ouro Preto" class="logo">
      <h2 class="header-title">Colorindo Ouro Preto</h2>
    </a>
    <h2 id="drawing-title">Casa com Sacada</h2>
  </header>

  <div class="canvas-container">
    <canvas id="drawing-canvas"></canvas>
  </div>

  <div class="toolbar">
    <button class="tool active" id="brush" title="Pincel">‚úèÔ∏è Pincel</button>
    <button class="tool" id="eraser" title="Borracha">üßΩ Borracha</button>

    <div class="tool-control">
      <label for="color-picker">Cor:</label>
      <input type="color" id="color-picker" value="#6F4E37" />
    </div>

    <div class="tool-control">
      <label for="brush-size">Tamanho:</label>
      <input type="range" id="brush-size" min="1" max="50" value="5" />
      <span id="brush-size-value">5</span>
    </div>

    <div class="tool-control">
      <label for="brush-transparency-slider">Transpar√™ncia:</label>
      <input type="range" id="brush-transparency-slider" min="0" max="100" value="100" />
      <span id="brush-transparency-value">100%</span>
    </div>

    <button class="tool" id="download">üíæ Baixar</button>
    <button class="tool" id="clear">üóëÔ∏è Limpar</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = new fabric.Canvas('drawing-canvas', {
        backgroundColor: 'white',
        isDrawingMode: true
      });

      // Ajusta o tamanho do canvas
      function resizeCanvas() {
        const container = document.querySelector('.canvas-container');
        canvas.setWidth(container.clientWidth);
        canvas.setHeight(container.clientHeight);
        canvas.renderAll();
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      let brushColor = '#6F4E37';
      let brushSize = 5;
      let brushTransparency = 1;

      // Configura√ß√£o inicial do pincel
      canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
      updateBrushColor();
      canvas.freeDrawingBrush.width = brushSize;

      // Carregar o desenho (SVG ou PNG como fallback)
      const urlParams = new URLSearchParams(window.location.search);
      const drawingName = urlParams.get('drawing') || 'casa_sacada';
      const drawingTitle = drawingName.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
      document.getElementById("drawing-title").textContent = drawingTitle;
      
      const svgPath = `../assets/drawings/${drawingName}.svg`;
      const pngPath = `../assets/drawings/${drawingName}.png`;

      // Tenta carregar SVG primeiro, depois PNG se falhar
      function loadDrawing() {
        fabric.loadSVGFromURL(svgPath, (objects, options) => {
          if (!objects || objects.length === 0) {
            console.log('SVG n√£o encontrado, tentando carregar PNG...');
            loadImage();
            return;
          }

          const svgObject = fabric.util.groupSVGElements(objects, {
            stroke: 'black',
            strokeWidth: 1,
            selectable: false,
            evented: false,
            opacity: 1
          });

          scaleAndCenterObject(svgObject);
          canvas.add(svgObject);
          canvas.sendToBack(svgObject);
        }, null, () => {
          console.log('Erro ao carregar SVG, tentando PNG...');
          loadImage();
        });
      }

      function loadImage() {
        fabric.Image.fromURL(pngPath, function(img) {
          scaleAndCenterObject(img);
          canvas.add(img);
          canvas.sendToBack(img);
        }, {
          crossOrigin: 'anonymous'
        });
      }
function scaleAndCenterObject(obj) {
  const bounds = obj.getBoundingRect(true);
  const scale = Math.min(
    canvas.width / bounds.width,
    canvas.height / bounds.height
  ) * 0.9;

  obj.scale(scale);
  canvas.centerObject(obj);
  obj.set({
    originX: 'center',
    originY: 'center',
    selectable: false,
    evented: false
  });
  obj.setCoords(); // atualiza coordenadas
}
      loadDrawing();

      // Controles da interface
      document.getElementById('brush-transparency-slider').addEventListener('input', (e) => {
        const sliderValue = parseInt(e.target.value);
        document.getElementById('brush-transparency-value').textContent = `${sliderValue}%`;
        brushTransparency = sliderValue / 100;
        updateBrushColor();
      });

      document.getElementById('brush').addEventListener('click', () => {
        document.getElementById('brush').classList.add('active');
        document.getElementById('eraser').classList.remove('active');
        canvas.isDrawingMode = true;
        updateBrushColor();
      });

      document.getElementById('eraser').addEventListener('click', () => {
        document.getElementById('eraser').classList.add('active');
        document.getElementById('brush').classList.remove('active');
        canvas.isDrawingMode = true;
        canvas.freeDrawingBrush.color = 'white';
      });

      document.getElementById('color-picker').addEventListener('input', (e) => {
        brushColor = e.target.value;
        updateBrushColor();
      });

      document.getElementById('brush-size').addEventListener('input', (e) => {
        brushSize = parseInt(e.target.value);
        canvas.freeDrawingBrush.width = brushSize;
        document.getElementById('brush-size-value').textContent = brushSize;
      });

      document.getElementById('download').addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = canvas.toDataURL({
          format: 'png',
          quality: 1
        });
        link.download = `${drawingName}_colorido_${new Date().getTime()}.png`;
        link.click();
      });

      document.getElementById('clear').addEventListener('click', () => {
        // Remove tudo exceto o primeiro objeto (o desenho de fundo)
        while(canvas.getObjects().length > 1) {
          canvas.remove(canvas.getObjects()[1]);
        }
      });

      function updateBrushColor() {
        canvas.freeDrawingBrush.color = hexToRgba(brushColor, brushTransparency);
      }

      function hexToRgba(hex, alpha = 1) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
    });
  </script>
</body>
</html>
