<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Casa Sacada - Pintura</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .tools {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    .tools label {
      font-weight: bold;
      margin-right: 5px;
    }
    .tools button {
      padding: 8px 15px;
      background-color: #6F4E37;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .tools button:hover {
      background-color: #5a3c2a;
    }
    #drawing-canvas {
      border: 1px solid #ddd;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="tools">
    <label for="color-picker">Cor:</label>
    <input type="color" id="color-picker" value="#6F4E37" />

    <label for="brush-size">Tamanho:</label>
    <input type="range" id="brush-size" min="1" max="50" value="5" />
    <span id="brush-size-value">5</span>

    <label for="transparency-slider">Transparência:</label>
    <input type="range" id="transparency-slider" min="0" max="100" value="100" />
    <span id="transparency-value">100%</span>

    <button id="brush">Pincel</button>
    <button id="eraser">Borracha</button>
    <button id="download">Download</button>
  </div>

  <canvas id="drawing-canvas" width="800" height="600"></canvas>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = new fabric.Canvas('drawing-canvas', {
        backgroundColor: 'white',
        isDrawingMode: true
      });

      let brushColor = '#6F4E37';
      let brushSize = 5;
      let brushTransparency = 1;
      let imageTransparency = 0.05; // Invertido para começar quase invisível

      const transparencySlider = document.getElementById('transparency-slider');
      const transparencyValue = document.getElementById('transparency-value');

      canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
      updateBrushColor();
      canvas.freeDrawingBrush.width = brushSize;

      const drawingName = 'teste1'; // SVG padrão
      const drawingPath = `assets/drawings/${drawingName}.svg`;

      let svgObject;

      fabric.loadSVGFromURL(drawingPath, (objects, options) => {
        if (!objects || objects.length === 0) {
          console.error('SVG não carregado ou vazio');
          alert('Desenho não encontrado. Por favor, verifique o arquivo SVG.');
          return;
        }

        svgObject = fabric.util.groupSVGElements(objects, {
          stroke: 'black',
          strokeWidth: 1,
          selectable: false,
          evented: false,
          opacity: imageTransparency
        });

        canvas.add(svgObject);
        canvas.centerObject(svgObject);
        canvas.renderAll();
      });

      transparencySlider.addEventListener('input', (e) => {
        const sliderValue = parseInt(e.target.value);
        transparencyValue.textContent = `${sliderValue}%`;

        brushTransparency = sliderValue / 100;
        updateBrushColor();

        // Ajuste mais intuitivo: 0% = imagem totalmente visível, 100% = imagem totalmente transparente
        imageTransparency = (100 - sliderValue) / 100;

        if (svgObject) {
          svgObject.set('opacity', imageTransparency);
          canvas.renderAll();
        }
      });

      document.getElementById('brush').addEventListener('click', () => {
        canvas.isDrawingMode = true;
        updateBrushColor();
      });

      document.getElementById('eraser').addEventListener('click', () => {
        canvas.isDrawingMode = true;
        canvas.freeDrawingBrush.color = 'rgba(255, 255, 255, 1)';
      });

      document.getElementById('color-picker').addEventListener('input', (e) => {
        brushColor = e.target.value;
        updateBrushColor();
      });

      document.getElementById('brush-size').addEventListener('input', (e) => {
        brushSize = parseInt(e.target.value);
        canvas.freeDrawingBrush.width = brushSize;
        document.getElementById('brush-size-value').textContent = brushSize;
      });

      document.getElementById('download').addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = canvas.toDataURL({
          format: 'png',
          quality: 1
        });
        link.download = `${drawingName}_colorido_${new Date().getTime()}.png`;
        link.click();
      });

      function updateBrushColor() {
        canvas.freeDrawingBrush.color = hexToRgba(brushColor, brushTransparency);
      }

      function hexToRgba(hex, alpha = 1) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
    });
  </script>
</body>
</html>
