<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Colorindo Ouro Preto</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../js/ paint.js" />
</head>
<body>
  <div class="app-container">
    <header class="header">
      <h1>Colorindo: <span id="drawing-title">Casa com Sacada</span></h1>
      <p>Use as ferramentas abaixo para colorir seu desenho</p>
    </header>
    
    <div class="canvas-container">
      <canvas id="drawing-canvas"></canvas>
    </div>
    
    <div class="toolbar-container">
      <div class="toolbar-scroll">
        <div class="toolbar">
          <button class="tool active" id="brush" title="Pincel">‚úèÔ∏è Pincel</button>
          <button class="tool" id="eraser" title="Borracha">üßΩ Borracha</button>

          <div class="tool-control">
            <label for="color-picker">Cor:</label>
            <input type="color" id="color-picker" value="#6F4E37" />
          </div>

          <div class="tool-control">
            <label for="brush-size">Tamanho:</label>
            <input type="range" id="brush-size" min="1" max="50" value="5" />
            <span id="brush-size-value">5</span>
          </div>

          <div class="tool-control">
            <label for="brush-transparency-slider">Transpar√™ncia Pincel:</label>
            <input type="range" id="brush-transparency-slider" min="0" max="100" value="100" />
            <span id="brush-transparency-value">100%</span>
          </div>

          <div class="tool-control">
            <label for="image-transparency-slider">Transpar√™ncia Desenho:</label>
            <input type="range" id="image-transparency-slider" min="0" max="95" value="0" />
            <span id="image-transparency-value">0%</span>
          </div>

          <button class="tool" id="download">üíæ Baixar Arte</button>
          <button class="tool" id="clear">üóëÔ∏è Limpar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.querySelector('.app-container');
        const toolbarContainer = document.querySelector('.toolbar-container');
        const canvasElement = document.getElementById('drawing-canvas');
        const headerElement = document.querySelector('.header');
        const contentContainer = document.querySelector('.content-container');

        function resizeCanvas() {
            if (window.innerWidth <= 768) {
                // Celular
                const toolbarHeight = toolbarContainer.offsetHeight;
                const headerHeight = headerElement.offsetHeight;
                const availableHeight = window.innerHeight - toolbarHeight - headerHeight;
                canvasElement.style.height = `${availableHeight}px`;
                canvasElement.style.width = `${window.innerWidth}px`;
                canvas.setWidth(window.innerWidth);
                canvas.setHeight(availableHeight);
            } else {
                // Desktop
                const availableWidth = window.innerWidth - 140; // Margem de 70px em cada lado
                const availableHeight = window.innerHeight - toolbarContainer.offsetHeight - headerElement.offsetHeight - 40; // Margem vertical
                const maxWidth = 900;
                const maxHeight = 800; // Altura m√°xima aproximada

                const canvasWidth = Math.min(availableWidth, maxWidth);
                const canvasHeight = Math.min(availableHeight, maxHeight);

                canvasElement.style.width = `${canvasWidth}px`;
                canvasElement.style.height = `${canvasHeight}px`;
                canvas.setWidth(canvasWidth);
                canvas.setHeight(canvasHeight);
            }

            if (svgObject) {
                const canvasWidth = canvas.getWidth();
                const canvasHeight = canvas.getHeight();
                const scaleX = canvasWidth / svgObject.width;
                const scaleY = canvasHeight / svgObject.height;
                const scale = Math.min(scaleX, scaleY);

                svgObject.scale(scale);
                svgObject.set({
                    left: (canvasWidth - svgObject.width * scale) / 2,
                    top: (canvasHeight - svgObject.height * scale) / 2,
                });
                canvas.sendToBack(svgObject);
                canvas.renderAll();
            } else {
                canvas.renderAll();
            }
        }

        const canvas = new fabric.Canvas('drawing-canvas', {
            backgroundColor: 'white',
            isDrawingMode: true
        });

        let brushColor = '#6F4E37';
        let brushSize = 5;
        let brushTransparency = 1;
        let imageTransparency = 0;
        let svgObject;

        // Obter elementos da UI
        const brushTransparencySlider = document.getElementById('brush-transparency-slider');
        const brushTransparencyValue = document.getElementById('brush-transparency-value');
        const imageTransparencySlider = document.getElementById('image-transparency-slider');
        const imageTransparencyValue = document.getElementById('image-transparency-value');

        // Configura√ß√£o inicial do pincel
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        updateBrushColor();
        canvas.freeDrawingBrush.width = brushSize;

        // Carregar o SVG
        const urlParams = new URLSearchParams(window.location.search);
        const drawingName = urlParams.get('drawing') || 'casa_sacada';
        const drawingTitle = drawingName.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        document.getElementById("drawing-title").textContent = drawingTitle;
        const drawingPath = `./assets/drawings/${drawingName}.svg`;

        fabric.loadSVGFromURL(drawingPath, (objects, options) => {
            if (!objects || objects.length === 0) throw new Error('SVG vazio ou inv√°lido');

            svgObject = fabric.util.groupSVGElements(objects, {
                stroke: 'black',
                strokeWidth: 1,
                selectable: false,
                evented: false,
                opacity: 1
            });
            resizeCanvas();
        });

        // Controles de transpar√™ncia e pincel (sem altera√ß√µes)
        brushTransparencySlider.addEventListener('input', (e) => {
            const sliderValue = parseInt(e.target.value);
            brushTransparencyValue.textContent = `${sliderValue}%`;
            brushTransparency = sliderValue / 100;
            updateBrushColor();
        });

        imageTransparencySlider.addEventListener('input', (e) => {
            const sliderValue = parseInt(e.target.value);
            const invertedTransparency = 1 - (sliderValue / 95 * 0.9);
            imageTransparencyValue.textContent = `${Math.round((1 - invertedTransparency) * 100)}%`;
            if (svgObject) {
                svgObject.set('opacity', invertedTransparency);
                canvas.renderAll();
            }
        });

        const brushBtn = document.getElementById("brush");
        const eraserBtn = document.getElementById("eraser");

        function setActiveTool(tool) {
            document.querySelectorAll(".tool").forEach(btn => btn.classList.remove("active"));
            tool.classList.add("active");
        }

        brushBtn.addEventListener("click", () => {
            setActiveTool(brushBtn);
            canvas.isDrawingMode = true;
            updateBrushColor();
        });

        eraserBtn.addEventListener("click", () => {
            setActiveTool(eraserBtn);
            canvas.isDrawingMode = true;
            canvas.freeDrawingBrush.color = 'white';
        });

        const colorPicker = document.getElementById('color-picker');
        colorPicker.addEventListener('input', (e) => {
            brushColor = e.target.value;
            updateBrushColor();
        });

        const sizeInput = document.getElementById('brush-size');
        const sizeValue = document.getElementById('brush-size-value');
        sizeInput.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            canvas.freeDrawingBrush.width = brushSize;
            sizeValue.textContent = brushSize;
        });

        function updateBrushColor() {
            canvas.freeDrawingBrush.color = hexToRgba(brushColor, brushTransparency);
        }

        document.getElementById('download').addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL({
                format: 'png',
                quality: 1
            });
            link.download = `${drawingName}_colorido_${new Date().getTime()}.png`;
            link.click();
        });

        document.getElementById('clear').addEventListener('click', () => {
            canvas.getObjects().forEach(obj => {
                if (obj !== svgObject) {
                    canvas.remove(obj);
                }
            });
        });

        function hexToRgba(hex, alpha = 1) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        brushTransparencySlider.value = 100;
        brushTransparencyValue.textContent = '100%';
        imageTransparencySlider.value = 90;
        imageTransparencyValue.textContent = '10%';

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    });
  </script>
</body>
</html> 